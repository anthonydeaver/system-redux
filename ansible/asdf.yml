  - git:
      repo: https://github.com/asdf-vm/asdf.git
      dest: "/Users/{{ lookup('env', 'USER') }}/.asdf"
      version: v0.11.3

  - name: "Create a default asdf configuration"
    template:
      src: templates/.asdfrc.j2
      dest: /Users/{{ lookup('env', 'USER') }}/.asdfrc
      owner: "{{ lookup('env', 'USER') }}"
      force: yes

  - name: "Install asdf plugins"
    shell: |
      source /Users/{{ lookup('env', 'USER') }}/.asdf/asdf.sh
      asdf plugin-add {{ item }} || exit 0
    with_items:
      - nodejs
      - python
      - awscli
      - direnv
      - jq
      - terraform

  - name: "Install Default Python"
    shell: |
      source /Users/{{ lookup('env', 'USER') }}/.asdf/asdf.sh
      asdf install python 3.10.6
      asdf global python 3.10.6
      pip3 install ansible
      pip3 install virtualenv
      pip3 install virtualenvwrapper
      asdf reshim python

  - name: "Install default node"
    shell: |
      source /Users/{{ lookup('env', 'USER') }}/.asdf/asdf.sh
      bash /Users/{{ lookup('env', 'USER') }}/.asdf/plugins/nodejs/bin/import-release-team-keyring
      asdf install nodejs 18.13.0
      asdf global nodejs 18.13.0

  - name: "Configure asdf for direnv"
    shell: |
      source /Users/{{ lookup('env', 'USER') }}/.asdf/asdf.sh
      export ASDF_DIRENV_IGNORE_MISSING_PLUGINS=1
      asdf direnv setup --shell zsh --version latest

  - name: "Configure asdf for pre-installed apps"
    shell: |
      source /Users/{{ lookup('env', 'USER') }}/.asdf/asdf.sh
      asdf global awscli system
      asdf global jq system
      asdf global terraform system
